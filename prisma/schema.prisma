// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  GURU_BK
  WALI_KELAS
  SISWA
}

enum AppointmentStatus {
  PENDING
  APPROVED
  REJECTED
  RESCHEDULED
  COMPLETED
  CANCELLED
}

enum PermissionType {
  MASUK
  KELUAR
}

enum ViolationCategory {
  PELANGGARAN
  PRESTASI
}

// User Management Models
model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  username           String    @unique
  passwordHash       String    @map("password_hash")
  role               Role
  fullName           String    @map("full_name")
  phone              String?
  isActive           Boolean   @default(true) @map("is_active")
  mustChangePassword Boolean   @default(false) @map("must_change_password")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")

  // Relations
  teacher  Teacher?
  student  Student?
  auditLogs AuditLog[]

  @@index([email])
  @@index([username])
  @@index([role])
  @@index([deletedAt])
  @@map("users")
}

model Teacher {
  id             String    @id @default(uuid())
  userId         String    @unique @map("user_id")
  nip            String?   @unique
  specialization String?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  user                        User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  homeroomClasses             ClassHomeroomTeacher[]
  studentCounselorAssignments StudentCounselorAssignment[]
  violationsRecorded          Violation[]                   @relation("ViolationRecorder")
  counselingJournals          CounselingJournal[]
  permissionsIssued           Permission[]
  appointmentsAsCounselor     Appointment[]

  @@index([userId])
  @@map("teachers")
}

model Student {
  id          String    @id @default(uuid())
  userId      String    @unique @map("user_id")
  nis         String    @unique
  nisn        String?   @unique
  classId     String?   @map("class_id")
  dateOfBirth DateTime? @map("date_of_birth") @db.Date
  address     String?   @db.Text
  parentName  String?   @map("parent_name")
  parentPhone String?   @map("parent_phone")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user                   User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  class                  Class?                       @relation(fields: [classId], references: [id], onDelete: SetNull)
  counselorAssignments   StudentCounselorAssignment[]
  violations             Violation[]
  counselingJournals     CounselingJournal[]
  permissions            Permission[]
  appointments           Appointment[]

  @@index([userId])
  @@index([classId])
  @@index([nis])
  @@map("students")
}

// Academic Structure Models
model AcademicYear {
  id        String    @id @default(uuid())
  name      String
  startDate DateTime  @map("start_date") @db.Date
  endDate   DateTime  @map("end_date") @db.Date
  isActive  Boolean   @default(false) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  classes                     Class[]
  homeroomTeachers            ClassHomeroomTeacher[]
  studentCounselorAssignments StudentCounselorAssignment[]

  @@unique([name, startDate, endDate], map: "name_startDate_endDate")
  @@index([isActive])
  @@map("academic_years")
}

model Class {
  id             String    @id @default(uuid())
  name           String
  gradeLevel     Int       @map("grade_level")
  academicYearId String    @map("academic_year_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  academicYear     AcademicYear               @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  students         Student[]
  homeroomTeachers ClassHomeroomTeacher[]

  @@unique([name, academicYearId], map: "name_academicYearId")
  @@index([academicYearId])
  @@index([gradeLevel])
  @@map("classes")
}

// Mapping Tables
model ClassHomeroomTeacher {
  id             String   @id @default(uuid())
  classId        String   @map("class_id")
  teacherId      String   @map("teacher_id")
  academicYearId String   @map("academic_year_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  class        Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher      Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([classId, academicYearId], map: "classId_academicYearId")
  @@index([classId])
  @@index([teacherId])
  @@map("class_homeroom_teachers")
}

model StudentCounselorAssignment {
  id             String   @id @default(uuid())
  studentId      String   @map("student_id")
  counselorId    String   @map("counselor_id")
  academicYearId String   @map("academic_year_id")
  assignedAt     DateTime @default(now()) @map("assigned_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  student      Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  counselor    Teacher      @relation(fields: [counselorId], references: [id], onDelete: Cascade)
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([studentId, academicYearId], map: "studentId_academicYearId")
  @@index([studentId])
  @@index([counselorId])
  @@index([academicYearId])
  @@map("student_counselor_assignments")
}

// Violation Management Models
model ViolationType {
  id          String             @id @default(uuid())
  code        String             @unique
  name        String
  description String?            @db.Text
  points      Int
  type        ViolationCategory
  category    String?
  isActive    Boolean            @default(true) @map("is_active")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  // Relations
  violations Violation[]

  @@index([code])
  @@index([type])
  @@index([isActive])
  @@map("violation_types")
}

model Violation {
  id              String    @id @default(uuid())
  studentId       String    @map("student_id")
  violationTypeId String    @map("violation_type_id")
  recordedBy      String    @map("recorded_by")
  incidentDate    DateTime  @map("incident_date") @db.Date
  description     String?   @db.Text
  points          Int
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  student       Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  violationType ViolationType  @relation(fields: [violationTypeId], references: [id], onDelete: Restrict)
  recorder      Teacher        @relation("ViolationRecorder", fields: [recordedBy], references: [id], onDelete: Restrict)

  @@index([studentId])
  @@index([violationTypeId])
  @@index([recordedBy])
  @@index([incidentDate])
  @@map("violations")
}

// Counseling Journal Model (ENCRYPTED)
model CounselingJournal {
  id               String    @id @default(uuid())
  studentId        String    @map("student_id")
  counselorId      String    @map("counselor_id")
  sessionDate      DateTime  @map("session_date")
  encryptedContent String    @map("encrypted_content") @db.Text
  encryptionIv     String    @map("encryption_iv")
  encryptionTag    String    @map("encryption_tag")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  counselor Teacher @relation(fields: [counselorId], references: [id], onDelete: Restrict)

  @@index([studentId])
  @@index([counselorId])
  @@index([sessionDate])
  @@map("counseling_journals")
}

// Permission Model
model Permission {
  id             String         @id @default(uuid())
  studentId      String         @map("student_id")
  issuedBy       String         @map("issued_by")
  permissionType PermissionType @map("permission_type")
  reason         String         @db.Text
  permissionDate DateTime       @map("permission_date") @db.Date
  startTime      DateTime       @map("start_time") @db.Time
  endTime        DateTime?      @map("end_time") @db.Time
  destination    String?
  notes          String?        @db.Text
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  issuer  Teacher @relation(fields: [issuedBy], references: [id], onDelete: Restrict)

  @@index([studentId])
  @@index([issuedBy])
  @@index([permissionDate])
  @@index([permissionType])
  @@map("permissions")
}

// Appointment Model
model Appointment {
  id              String            @id @default(uuid())
  studentId       String            @map("student_id")
  counselorId     String            @map("counselor_id")
  appointmentDate DateTime          @map("appointment_date") @db.Date
  startTime       DateTime          @map("start_time") @db.Time
  endTime         DateTime          @map("end_time") @db.Time
  status          AppointmentStatus @default(PENDING)
  reason          String            @db.Text
  rejectionReason String?           @map("rejection_reason") @db.Text
  notes           String?           @db.Text
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  counselor Teacher @relation(fields: [counselorId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([counselorId])
  @@index([appointmentDate])
  @@index([status])
  @@map("appointments")
}

// Audit Log Model
model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// School Information Model
model SchoolInfo {
  id            String   @id @default(uuid())
  name          String   @db.VarChar(200)
  address       String   @db.VarChar(500)
  phone         String   @db.VarChar(20)
  email         String   @db.VarChar(100)
  website       String?  @db.VarChar(100)
  principalName String   @map("principal_name") @db.VarChar(100)
  principalNip  String   @map("principal_nip") @db.VarChar(18)
  logoPath      String?  @map("logo_path") @db.VarChar(255)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("school_info")
}
